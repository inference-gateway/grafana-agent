version: '3'

vars:
  CLUSTER_NAME: k3d-grafana-agent
  K3D_CLUSTER_NAME: grafana-agent
  REGISTRY_PORT: 5000
  NAMESPACE: grafana-agent

tasks:
  check-requirements:
    desc: Check if required tools are installed
    run: once
    cmds:
      - command -v ctlptl >/dev/null 2>&1 || (echo "âŒ ctlptl is not installed. Please install it first." && exit 1)
      - command -v k3d >/dev/null 2>&1 || (echo "âŒ k3d is not installed. Please install it first." && exit 1)
      - command -v kubectl >/dev/null 2>&1 || (echo "âŒ kubectl is not installed. Please install it first." && exit 1)
      - command -v docker >/dev/null 2>&1 || (echo "âŒ docker is not installed. Please install it first." && exit 1)
      - echo "âœ… All required tools are installed"

  create-cluster:
    desc: Create k3d cluster with ctlptl
    run: once
    deps:
      - check-requirements
    cmds:
      - echo "ğŸš€ Creating k3d cluster with ctlptl..."
      - ctlptl apply -f cluster.yaml
      - echo "âœ… Cluster created successfully"
    status:
      - ctlptl get cluster {{.CLUSTER_NAME}} 2>/dev/null

  delete-cluster:
    desc: Delete k3d cluster
    cmds:
      - echo "ğŸ—‘ï¸  Deleting k3d cluster..."
      - ctlptl delete -f cluster.yaml --cascade=true
      - echo "âœ… Cluster deleted successfully"

  install-operators:
    desc: Install Prometheus, Grafana, and Inference Gateway operators
    deps:
      - create-cluster
    cmds:
      - echo "ğŸ“¦ Installing Prometheus Operator..."
      - kubectl apply --server-side -f https://github.com/prometheus-operator/prometheus-operator/releases/latest/download/bundle.yaml
      - echo "â³ Waiting for Prometheus Operator to be ready..."
      - kubectl wait --for=condition=available --timeout=300s deployment/prometheus-operator -n default || true
      - echo "âœ… Prometheus Operator installed"
      - echo ""
      - echo "ğŸ“¦ Installing Grafana Operator (cluster-scoped)..."
      - kubectl create -f https://github.com/grafana/grafana-operator/releases/latest/download/kustomize-cluster_scoped.yaml || kubectl replace -f https://github.com/grafana/grafana-operator/releases/latest/download/kustomize-cluster_scoped.yaml
      - echo "â³ Waiting for Grafana Operator to be ready..."
      - kubectl wait --for=condition=available --timeout=300s deployment/grafana-operator-controller-manager -n grafana-operator-system || true
      - echo "âœ… Grafana Operator installed"
      - echo ""
      - echo "ğŸ“¦ Installing Inference Gateway Operator..."
      - kubectl apply -f https://github.com/inference-gateway/operator/releases/latest/download/install.yaml
      - echo "â³ Waiting for Inference Gateway Operator to be ready..."
      - kubectl wait --for=condition=available --timeout=300s deployment/operator-inference-gateway -n inference-gateway-system || true
      - echo "âœ… Inference Gateway Operator installed"

  build-images:
    desc: Build and import images to k3d cluster
    deps:
      - create-cluster
    cmds:
      - echo "ğŸ—ï¸  Building grafana-agent image..."
      - docker build -t localhost:{{.REGISTRY_PORT}}/grafana-agent:latest -f ../../Dockerfile ../..
      - echo "ğŸ“¦ Importing grafana-agent image to k3d cluster..."
      - k3d image import localhost:{{.REGISTRY_PORT}}/grafana-agent:latest -c {{.K3D_CLUSTER_NAME}}
      - echo "âœ… grafana-agent image built and imported"
      - echo ""
      - echo "ğŸ—ï¸  Building demo-service image..."
      - docker build -t localhost:{{.REGISTRY_PORT}}/demo-otel-service:latest -f ../../examples/docker-compose/demo-service/Dockerfile ../../examples/docker-compose/demo-service
      - echo "ğŸ“¦ Importing demo-service image to k3d cluster..."
      - k3d image import localhost:{{.REGISTRY_PORT}}/demo-otel-service:latest -c {{.K3D_CLUSTER_NAME}}
      - echo "âœ… demo-service image built and imported"

  create-secrets:
    desc: Create secrets with API keys in inference-gateway namespace
    deps:
      - create-cluster
    cmds:
      - echo "ğŸ” Creating API keys secret in inference-gateway namespace..."
      - |
        if [ -f .env ]; then
          source .env
          kubectl create namespace inference-gateway --dry-run=client -o yaml | kubectl apply -f -
          kubectl create secret generic api-keys \
            --from-literal=deepseek-api-key="${DEEPSEEK_API_KEY:-}" \
            --from-literal=google-api-key="${GOOGLE_API_KEY:-}" \
            --from-literal=anthropic-api-key="${ANTHROPIC_API_KEY:-}" \
            --from-literal=openai-api-key="${OPENAI_API_KEY:-}" \
            --namespace=inference-gateway \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Secrets created in inference-gateway namespace"
        else
          echo "âš ï¸  .env file not found. Creating secret with empty values..."
          kubectl create namespace inference-gateway --dry-run=client -o yaml | kubectl apply -f -
          kubectl create secret generic api-keys \
            --from-literal=deepseek-api-key="" \
            --from-literal=google-api-key="" \
            --from-literal=anthropic-api-key="" \
            --from-literal=openai-api-key="" \
            --namespace=inference-gateway \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "âš ï¸  Please update the secret with your actual API keys:"
          echo "   kubectl edit secret api-keys -n inference-gateway"
        fi

  deploy:
    desc: Deploy all manifests to the cluster
    deps:
      - install-operators
      - build-images
      - create-secrets
    cmds:
      - echo "ğŸš€ Deploying application manifests..."
      - kubectl apply -f manifests/00-namespace.yaml
      - echo "â³ Waiting for operators to be ready before deploying CRDs..."
      - sleep 10
      - kubectl apply -f manifests/01-grafana.yaml
      - kubectl apply -f manifests/02-dashboard.yaml
      - kubectl apply -f manifests/03-prometheus.yaml
      - kubectl apply -f manifests/04-demo-service.yaml
      - kubectl apply -f manifests/05-inference-gateway.yaml
      - kubectl apply -f manifests/06-grafana-agent.yaml
      - echo "â³ Waiting a moment before deploying ServiceMonitors..."
      - sleep 5
      - kubectl apply -f manifests/07-servicemonitors.yaml
      - echo "âœ… All manifests deployed"

  wait-ready:
    desc: Wait for all services to be ready
    cmds:
      - echo "â³ Waiting for all services to be ready..."
      - echo "â³ Waiting for Prometheus (StatefulSet)..."
      - kubectl wait --for=jsonpath='{.status.availableReplicas}'=1 --timeout=300s statefulset/prometheus-prometheus -n {{.NAMESPACE}} || true
      - kubectl wait --for=condition=available --timeout=300s deployment/demo-service -n {{.NAMESPACE}} || true
      - kubectl wait --for=condition=available --timeout=300s deployment/grafana-agent -n {{.NAMESPACE}} || true
      - echo "â³ Waiting for Grafana to be ready (this may take a minute)..."
      - kubectl wait --for=condition=available --timeout=300s deployment/grafana-deployment -n {{.NAMESPACE}} || true
      - echo "â³ Waiting for Inference Gateway to be ready..."
      - kubectl wait --for=condition=available --timeout=300s deployment/inference-gateway -n {{.NAMESPACE}} || true
      - echo "âœ… All services are ready!"

  show-urls:
    desc: Show access URLs for services
    cmds:
      - echo ""
      - echo "ğŸŒ Service URLs:"
      - 'echo "   Grafana:          http://localhost:3000 (admin/admin)"'
      - 'echo "   Prometheus:       http://localhost:9090"'
      - 'echo "   Demo Service:     http://localhost:8082"'
      - 'echo "   Grafana Agent:    http://localhost:8080"'
      - echo ""
      - echo "ğŸ“Š Quick checks:"
      - 'echo "   kubectl get all -n {{.NAMESPACE}}"'
      - 'echo "   kubectl logs -f deployment/grafana-agent -n {{.NAMESPACE}}"'
      - echo ""

  up:
    desc: Complete setup - create cluster, install operators, build images, and deploy
    cmds:
      - task: deploy
      - task: wait-ready
      - task: show-urls

  down:
    desc: Tear down everything
    cmds:
      - task: delete-cluster

  restart:
    desc: Restart the grafana-agent deployment
    cmds:
      - echo "ğŸ”„ Restarting grafana-agent..."
      - kubectl rollout restart deployment/grafana-agent -n {{.NAMESPACE}}
      - kubectl rollout status deployment/grafana-agent -n {{.NAMESPACE}}
      - echo "âœ… grafana-agent restarted"

  logs:
    desc: Show logs for grafana-agent
    cmds:
      - kubectl logs -f deployment/grafana-agent -n {{.NAMESPACE}}

  logs-gateway:
    desc: Show logs for inference-gateway
    cmds:
      - kubectl logs -f deployment/inference-gateway -n {{.NAMESPACE}}

  logs-grafana:
    desc: Show logs for Grafana
    cmds:
      - kubectl logs -f deployment/grafana-deployment -n {{.NAMESPACE}}

  status:
    desc: Show status of all resources
    cmds:
      - echo "ğŸ“Š Cluster status:"
      - kubectl get nodes
      - echo ""
      - echo "ğŸ“¦ Pods in {{.NAMESPACE}}:"
      - kubectl get pods -n {{.NAMESPACE}}
      - echo ""
      - echo "ğŸ”Œ Services in {{.NAMESPACE}}:"
      - kubectl get svc -n {{.NAMESPACE}}
      - echo ""
      - echo "ğŸ¯ Gateway resources:"
      - kubectl get gateway -n {{.NAMESPACE}}
      - echo ""
      - echo "ğŸ“Š Grafana resources:"
      - kubectl get grafana,grafanadatasource,grafanadashboard -n {{.NAMESPACE}}

  rebuild-agent:
    desc: Rebuild and redeploy grafana-agent
    cmds:
      - echo "ğŸ—ï¸  Rebuilding grafana-agent..."
      - docker build -t localhost:{{.REGISTRY_PORT}}/grafana-agent:latest -f ../../Dockerfile ../..
      - echo "ğŸ“¦ Importing grafana-agent image to k3d cluster..."
      - k3d image import localhost:{{.REGISTRY_PORT}}/grafana-agent:latest -c {{.K3D_CLUSTER_NAME}}
      - echo "â™»ï¸  Restarting grafana-agent deployment..."
      - kubectl rollout restart deployment/grafana-agent -n {{.NAMESPACE}}
      - kubectl rollout status deployment/grafana-agent -n {{.NAMESPACE}}
      - echo "âœ… grafana-agent rebuilt and redeployed"

  port-forward-grafana:
    desc: Port forward Grafana (if NodePort doesn't work)
    cmds:
      - kubectl port-forward -n {{.NAMESPACE}} svc/grafana-service 3000:3000

  port-forward-prometheus:
    desc: Port forward Prometheus (if NodePort doesn't work)
    cmds:
      - kubectl port-forward -n {{.NAMESPACE}} svc/prometheus 9090:9090

  clean:
    desc: Clean up resources without deleting the cluster
    cmds:
      - echo "ğŸ§¹ Cleaning up resources..."
      - kubectl delete -f manifests/07-servicemonitors.yaml --ignore-not-found=true
      - kubectl delete -f manifests/06-grafana-agent.yaml --ignore-not-found=true
      - kubectl delete -f manifests/05-inference-gateway.yaml --ignore-not-found=true
      - kubectl delete -f manifests/04-demo-service.yaml --ignore-not-found=true
      - kubectl delete -f manifests/03-prometheus.yaml --ignore-not-found=true
      - kubectl delete -f manifests/02-dashboard.yaml --ignore-not-found=true
      - kubectl delete -f manifests/01-grafana.yaml --ignore-not-found=true
      - kubectl delete -f manifests/00-namespace.yaml --ignore-not-found=true
      - echo "âœ… Resources cleaned up"

  help:
    desc: Show available tasks
    cmds:
      - task --list