---
services:
  agent:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: grafana-agent
    environment:
      A2A_PORT: 8080
      A2A_DEBUG: true
      A2A_AGENT_URL: http://localhost:8080
      A2A_STREAMING_STATUS_UPDATE_INTERVAL: 1s
      A2A_SERVER_READ_TIMEOUT: 120s
      A2A_SERVER_WRITE_TIMEOUT: 120s
      A2A_SERVER_IDLE_TIMEOUT: 120s
      A2A_SERVER_DISABLE_HEALTHCHECK_LOG: true
      A2A_AGENT_CARD_FILE_PATH: .well-known/agent-card.json
      A2A_AGENT_CLIENT_PROVIDER: ${A2A_AGENT_CLIENT_PROVIDER}
      A2A_AGENT_CLIENT_MODEL: ${A2A_AGENT_CLIENT_MODEL}
      A2A_AGENT_CLIENT_BASE_URL: http://inference-gateway:8080/v1
      A2A_AGENT_CLIENT_TIMEOUT: 30s
      A2A_AGENT_CLIENT_MAX_RETRIES: 3
      A2A_AGENT_CLIENT_MAX_CHAT_COMPLETION_ITERATIONS: 20
      A2A_AGENT_CLIENT_MAX_TOKENS: 4096
      A2A_AGENT_CLIENT_TEMPERATURE: 0.7
      A2A_AGENT_CLIENT_TOOLS_CREATE_ARTIFACT: true
      A2A_CAPABILITIES_STREAMING: true
      A2A_CAPABILITIES_PUSH_NOTIFICATIONS: false
      A2A_CAPABILITIES_STATE_TRANSITION_HISTORY: false
      A2A_TASK_RETENTION_MAX_COMPLETED_TASKS: 100
      A2A_TASK_RETENTION_MAX_FAILED_TASKS: 50
      A2A_TASK_RETENTION_CLEANUP_INTERVAL: 5m
      A2A_QUEUE_PROVIDER: memory
      A2A_QUEUE_URL: ""
      A2A_QUEUE_MAX_SIZE: 100
      A2A_QUEUE_CLEANUP_INTERVAL: 500s
      A2A_AUTH_ENABLE: false
      A2A_ARTIFACTS_ENABLE: true
      A2A_ARTIFACTS_SERVER_HOST: agent
      A2A_ARTIFACTS_SERVER_PORT: 8081
      A2A_ARTIFACTS_STORAGE_PROVIDER: filesystem
      A2A_ARTIFACTS_STORAGE_BASE_PATH: /tmp/artifacts
      A2A_ARTIFACTS_RETENTION_MAX_ARTIFACTS: 10
      A2A_ARTIFACTS_RETENTION_MAX_AGE: 24h
      A2A_ARTIFACTS_RETENTION_CLEANUP_INTERVAL: 24h
      GRAFANA_URL: http://grafana:3000
      GRAFANA_API_KEY: ${GRAFANA_API_KEY:-}
      GRAFANA_USERNAME: ${GRAFANA_USERNAME:-admin}
      GRAFANA_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    volumes:
      - ./artifacts:/tmp/artifacts
    networks:
      - a2a-network
    depends_on:
      - grafana
      - prometheus

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: true
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
      GF_AUTH_DISABLE_LOGIN_FORM: false
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USERNAME:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: ""
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./provisioning/dashboards:/etc/grafana/provisioning/dashboards
    ports:
      - "3000:3000"
    networks:
      - a2a-network

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-storage:/prometheus
    ports:
      - "9090:9090"
    networks:
      - a2a-network

  demo-service:
    build:
      context: ./demo-service
      dockerfile: Dockerfile
    container_name: demo-otel-service
    environment:
      OTEL_SERVICE_NAME: demo-service
      OTEL_EXPORTER_PROMETHEUS_PORT: 8080
      METRICS_INTERVAL: 5s
    ports:
      - "8082:8080"
    networks:
      - a2a-network

  inference-gateway:
    image: ghcr.io/inference-gateway/inference-gateway:latest
    container_name: inference-gateway
    environment:
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      SERVER_READ_TIMEOUT: 530s
      SERVER_WRITE_TIMEOUT: 530s
      CLIENT_TIMEOUT: 530s
      CLIENT_IDLE_CONN_TIMEOUT: 130s
      CLIENT_RESPONSE_HEADER_TIMEOUT: 120s
    networks:
      - a2a-network

  cli:
    image: ghcr.io/inference-gateway/cli:latest
    pull_policy: always
    volumes:
      - ./downloads:/tmp/downloads
    environment:
      INFER_LOGGING_DEBUG: true
      INFER_GATEWAY_URL: http://inference-gateway:8080
      INFER_A2A_ENABLED: true
      INFER_TOOLS_ENABLED: false
      INFER_AGENT_MODEL: deepseek/deepseek-chat
      INFER_A2A_AGENTS: |
        http://agent:8080
      INFER_A2A_DOWNLOAD_ARTIFACTS_DOWNLOAD_DIR: /tmp/downloads
    command:
      - chat
    networks:
      - a2a-network
    profiles:
      - manual

  a2a-debugger:
    image: ghcr.io/inference-gateway/a2a-debugger:latest
    pull_policy: always
    entrypoint:
      - /a2a
      - --server-url
      - http://agent:8080
      - --timeout
      - 500s
    networks:
      - a2a-network
    profiles:
      - manual

networks:
  a2a-network:
    driver: bridge

volumes:
  grafana-storage:
  prometheus-storage:
